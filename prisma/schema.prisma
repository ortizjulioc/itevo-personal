generator client {
    provider = "prisma-client-js"
    previewFeatures = ["omitApi"] // Add this line
}

datasource db {
    provider = "mysql"
    url      = env("DATABASE_URL")
}

model User { // Usuarios del sistema
    id        String   @id @default(uuid())
    username  String   @unique
    email     String   @unique
    name      String
    lastName  String   @map("last_name")
    phone     String
    password  String?
    search    String?  @default("")
    inactive  Boolean  @default(false)
    deleted   Boolean  @default(false)
    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    roleBranch UserRoleBranch[]
}

model Role { // Roles de los usuarios
    id             String   @id @default(uuid())
    name           String
    normalizedName String   @unique @map("normalized_name")
    deleted        Boolean  @default(false)
    createdAt      DateTime @default(now()) @map("created_at")
    updatedAt      DateTime @updatedAt @map("updated_at")

    userRole UserRoleBranch[]
}

model Branch { // Sucursales
    id        String   @id @default(uuid())
    name      String
    address   String
    phone     String?
    deleted   Boolean  @default(false)
    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    userRole     UserRoleBranch[]
    courseBranch CourseBranch[]
}

model UserRoleBranch { // Relacion de roles con sucursales
    id       String @id @default(uuid())
    userId   String @map("user_id")
    roleId   String @map("role_id")
    branchId String @map("branch_id")

    user   User   @relation(fields: [userId], references: [id])
    role   Role   @relation(fields: [roleId], references: [id])
    branch Branch @relation(fields: [branchId], references: [id])

    @@unique([userId, roleId, branchId])
    @@map("user_role_branch")
}

model Teacher { // Profesores
    id             String   @id @default(uuid())
    code           Int   @unique @default(autoincrement())
    firstName      String   @map("first_name")
    lastName       String   @map("last_name")
    identification String   @unique
    prefix         String?  @map("prefix") @default("P")
    address        String?
    phone          String?
    email          String?   @unique
    commissionRate Float?    @map("commission_rate")
    createdAt      DateTime @default(now()) @map("created_at")
    updatedAt      DateTime @updatedAt @map("updated_at")
    deleted      Boolean  @default(false)
    courseBranch   CourseBranch[]
    accountPayable AccountPayable[]
}

model Student { // Estudiantes
    id              String   @id @default(uuid())
    code            String   @unique // Codigo del estudiante (matricula)
    firstName       String   @map("first_name") // Nombres
    lastName        String   @map("last_name") // Apellidos
    identification  String? // En estudiates puede estar vacio
    phone           String // Telefono
    email           String?   @unique // Correo
    address         String? // Direccion
    hasTakenCourses Boolean  @default(false) @map("has_taken_courses")
    createdAt       DateTime @default(now()) @map("created_at")
    updatedAt       DateTime @updatedAt @map("updated_at")
    deleted         Boolean  @default(false)
    enrollment        Enrollment[]
    graduation        Graduation[]
    accountReceivable AccountReceivable[]
}

model Course { // Cursos
    id                 String   @id @default(uuid())
    code               String   @unique // Codigo
    name               String // Nombre
    description        String? // Descripcion
    duration           Int? // Duracion en horas
    requiresGraduation Boolean  @map("requires_graduation") @default(false)// Requiere graduacion
    createdAt          DateTime @default(now()) @map("created_at")
    updatedAt          DateTime @updatedAt @map("updated_at")
    deleted   Boolean  @default(false)
    prerequisites Prerequisite[] @relation("CoursePrerequisite")
    requiredBy    Prerequisite[] @relation("PrerequisiteCourse")
    courseBranch  CourseBranch[]
    graduation    Graduation[]
}

model Prerequisite { // Requisitos de los cursos
    courseId       String @map("course_id") // ID del curso
    prerequisiteId String @map("prerequisite_id") // ID del curso pre-requisito

    course       Course @relation("CoursePrerequisite", fields: [courseId], references: [id])
    prerequisite Course @relation("PrerequisiteCourse", fields: [prerequisiteId], references: [id])

    @@id([courseId, prerequisiteId]) // Llave compuesta
}

model Promotion { // Promociones de los cursos
    id          String   @id @default(uuid())
    description String // Descripcion
    startDate   DateTime @map("start_date") // fechaInicio
    endDate     DateTime @map("end_date") // fechaFin
    createdAt   DateTime @default(now()) @map("created_at")
    updatedAt   DateTime @updatedAt @map("updated_at")

    courseBranch CourseBranch[]
    graduation   Graduation[]
}

model CourseBranch { // Cursos en las sucursales
    id             String   @id @default(uuid())
    promotionId    String   @map("promotion_id") // ID de la promoción
    branchId       String   @map("branch_id") // ID de la sucursal
    teacherId      String   @map("teacher_id") // ID del profesor
    courseId       String   @map("course_id") // ID del curso
    amount         Float // Monto
    modality       String // Modalidad (presencial, virtual, híbrida)
    startDate      DateTime @map("start_date") // Fecha de inicio
    endDate        DateTime @map("end_date") // Fecha de fin
    commissionRate Float    @map("commission_rate") // Porcentaje de comisión
    createdAt      DateTime @default(now()) @map("created_at")
    updatedAt      DateTime @updatedAt @map("updated_at")

    promotion         Promotion           @relation(fields: [promotionId], references: [id])
    branch            Branch              @relation(fields: [branchId], references: [id])
    teacher           Teacher             @relation(fields: [teacherId], references: [id])
    course            Course              @relation(fields: [courseId], references: [id])
    schedules         Schedule[] // Relación con horarios
    enrollment        Enrollment[]
    accountReceivable AccountReceivable[]
    accountPayable    AccountPayable[]

    @@map("course_branch")
}

model Schedule { // Horarios de los cursos
    id             String   @id @default(uuid())
    courseBranchId String   @map("course_branch_id") // ID del CursoSucursal
    startTime      DateTime @map("start_time") // Hora de inicio
    endTime        DateTime @map("end_time") // Hora de fin
    weekday        Int // Día de la semana (0 = Domingo, 6 = Sábado)
    createdAt      DateTime @default(now()) @map("created_at")
    updatedAt      DateTime @updatedAt @map("updated_at")

    courseBranch CourseBranch @relation(fields: [courseBranchId], references: [id])
    attendance   Attendance[]
}

enum EnrollmentStatus { // Estados de las matriculaciones de los estudiantes en los cursos
    waiting
    enrolled
    completed
    abandoned
}

model Enrollment { // Cursos en los que se matricula un estudiante
    id             String           @id @default(uuid())
    studentId      String           @map("student_id") // ID del estudiante
    courseBranchId String           @map("course_branch_id") // ID del CursoSucursal
    enrollmentDate DateTime         @map("enrollment_date") // Fecha de matriculación
    status         EnrollmentStatus // Estado de la matriculación
    createdAt      DateTime         @default(now()) @map("created_at")
    updatedAt      DateTime         @updatedAt @map("updated_at")

    student      Student      @relation(fields: [studentId], references: [id])
    courseBranch CourseBranch @relation(fields: [courseBranchId], references: [id])
    attendance   Attendance[]
}

enum AttendanceStatus { // Estados de las asistencias
    present
    absent
    excused
}

model Attendance { // Llevar asistencias de los estudiantes
    id           String           @id @default(uuid())
    enrollmentId String           @map("enrollment_id") // Enrollment ID
    scheduleId   String           @map("schedule_id") // Schedule ID
    date         DateTime // Date of attendance
    status       AttendanceStatus // Status of attendance
    createdAt    DateTime         @default(now()) @map("created_at")
    updatedAt    DateTime         @updatedAt @map("updated_at")

    enrollment Enrollment @relation(fields: [enrollmentId], references: [id])
    schedule   Schedule   @relation(fields: [scheduleId], references: [id])
}

enum GraduationType { // Tipos de graduaciones
    diploma
    certificate
    juramentation
}

enum GraduationStatus { // Estados de las graduaciones
    pending
    completed
    canceled
}

model Graduation { // Graduaciones de los estudiantes
    id             String           @id @default(uuid())
    studentId      String           @map("student_id") // ID del estudiante
    promotionId    String           @map("promotion_id") // ID de la promoción
    courseId       String           @map("course_id") // ID del curso
    graduationType GraduationType   @map("graduation_type") // Tipo de graduación
    status         GraduationStatus // Estado de la graduación
    date           DateTime // Fecha de graduación
    createdAt      DateTime         @default(now()) @map("created_at")
    updatedAt      DateTime         @updatedAt @map("updated_at")

    student   Student   @relation(fields: [studentId], references: [id])
    promotion Promotion @relation(fields: [promotionId], references: [id])
    course    Course    @relation(fields: [courseId], references: [id])
}

model GraduationPrice { // Precios de graduación
    id                             String         @id @default(uuid())
    graduationType                 GraduationType @map("graduation_type") // Tipo de graduación
    basePrice                      Float          @map("base_price") // Precio base
    discountForPreviousCourses     Float          @map("discount_for_previous_courses") // Descuento por cursos previos
    discountForMultipleEnrollments Float          @map("discount_for_multiple_enrollments") // Descuento por múltiples matriculaciones
    createdAt                      DateTime       @default(now()) @map("created_at")
    updatedAt                      DateTime       @updatedAt @map("updated_at")
}

enum AccountStatus { // Estados de las cuentas por cobrar y pagar de los estudiantes
    pending
    paid
    canceled
}

model AccountReceivable {
    id             String        @id @default(uuid())
    studentId      String        @map("student_id") // ID del estudiante
    courseBranchId String        @map("course_branch_id") // ID del CursoSucursal
    installment    Int // Número de la cuota (1, 2, 3, ...)
    amount         Float // Monto de la cuota
    dueDate        DateTime      @map("due_date") // Fecha de vencimiento
    status         AccountStatus // Estado (pendiente, pagado, etc.)
    createdAt      DateTime      @default(now()) @map("created_at")
    updatedAt      DateTime      @updatedAt @map("updated_at")

    student      Student      @relation(fields: [studentId], references: [id])
    courseBranch CourseBranch @relation(fields: [courseBranchId], references: [id])

    @@map("account_receivable")
}

enum PaymentStatus {
    pending
    paid
    canceled
}

model AccountPayable {
    id             String        @id @default(uuid())
    teacherId      String        @map("teacher_id") // ID del teacher
    courseBranchId String        @map("course_branch_id") // ID del CursoSucursal
    amount         Float // Monto a pagar al teacher
    dueDate        DateTime      @map("due_date") // Fecha de vencimiento
    status         PaymentStatus // Estado (pendiente, pagado, etc.)
    createdAt      DateTime      @default(now()) @map("created_at")
    updatedAt      DateTime      @updatedAt @map("updated_at")

    teacher      Teacher      @relation(fields: [teacherId], references: [id])
    courseBranch CourseBranch @relation(fields: [courseBranchId], references: [id])

    @@map("account_payable")
}


model Setting { // Configuraciones principales de la empresa
    id        String   @id @default(uuid())
    rnc       String   @unique
    companyName String   @map("company_name")
    address   String
    phone     String
    email     String
    logo      String
    defaultPassword String? @map("default_password")
    deleted   Boolean  @default(false)
    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")
}

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "mysql"
    url      = env("DATABASE_URL")
}

model User {
    id        String   @id @default(uuid())
    username  String   @unique
    email     String   @unique
    name      String
    lastName  String   @map("last_name")
    phone     String
    password  String?
    search    String?  @default("")
    inactive  Boolean  @default(false)
    deleted   Boolean  @default(false)
    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    roleBranch          UserRoleBranch[]
    CashMovement        CashMovement[]
    CashRegister        CashRegister[]
    CashRegisterClosure CashRegisterClosure[]
    Invoice             Invoice[]
    Quotation           Quotation[]

    @@map("users")
}

model Role {
    id             String   @id @default(uuid())
    name           String
    normalizedName String   @unique @map("normalized_name")
    deleted        Boolean  @default(false)
    createdAt      DateTime @default(now()) @map("created_at")
    updatedAt      DateTime @updatedAt @map("updated_at")

    userRole UserRoleBranch[]

    @@map("roles")
}

model Branch {
    id        String   @id @default(uuid())
    name      String
    address   String
    phone     String?
    deleted   Boolean  @default(false)
    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    userRole     UserRoleBranch[]
    courseBranch CourseBranch[]
    CashRegister CashRegister[]

    @@map("branches")
}

model UserRoleBranch {
    id       String @id @default(uuid())
    userId   String @map("user_id")
    roleId   String @map("role_id")
    branchId String @map("branch_id")

    user   User   @relation(fields: [userId], references: [id])
    role   Role   @relation(fields: [roleId], references: [id])
    branch Branch @relation(fields: [branchId], references: [id])

    @@unique([userId, roleId, branchId])
    @@map("users_roles_branches")
}

model Teacher {
    id             String           @id @default(uuid())
    code           Int              @unique @default(autoincrement())
    firstName      String           @map("first_name")
    lastName       String           @map("last_name")
    identification String           @unique
    prefix         String?          @default("P") @map("prefix")
    address        String?
    phone          String?
    email          String?          @unique
    commissionRate Float?           @map("commission_rate")
    createdAt      DateTime         @default(now()) @map("created_at")
    updatedAt      DateTime         @updatedAt @map("updated_at")
    deleted        Boolean          @default(false)
    courseBranch   CourseBranch[]
    accountPayable AccountPayable[]

    @@map("teachers")
}

model Student {
    id              String   @id @default(uuid())
    code            String   @unique // Codigo del estudiante (matricula)
    firstName       String   @map("first_name") // Nombres
    lastName        String   @map("last_name") // Apellidos
    identification  String? // En estudiates puede estar vacio
    phone           String? // Telefono
    email           String?  @unique // Correo
    address         String? // Direccion
    hasTakenCourses Boolean  @default(false) @map("has_taken_courses")
    createdAt       DateTime @default(now()) @map("created_at")
    updatedAt       DateTime @updatedAt @map("updated_at")
    deleted         Boolean  @default(false)

    enrollment        Enrollment[]
    graduation        Graduation[]
    accountReceivable AccountReceivable[]
    Invoice           Invoice[]
    Quotation         Quotation[]

    @@map("students")
}

model Course {
    id                 String   @id @default(uuid())
    code               String   @unique // Codigo
    name               String // Nombre
    description        String? // Descripcion
    duration           Int? // Duracion en horas
    requiresGraduation Boolean  @default(false) @map("requires_graduation") // Requiere graduacion
    createdAt          DateTime @default(now()) @map("created_at")
    updatedAt          DateTime @updatedAt @map("updated_at")
    deleted            Boolean  @default(false)

    prerequisites Prerequisite[] @relation("CoursePrerequisite")
    requiredBy    Prerequisite[] @relation("PrerequisiteCourse")
    courseBranch  CourseBranch[]
    graduation    Graduation[]

    @@map("courses")
}

model Prerequisite {
    courseId       String   @map("course_id") // ID del curso
    prerequisiteId String   @map("prerequisite_id") // ID del curso pre-requisito
    createdAt      DateTime @default(now()) @map("created_at")
    updatedAt      DateTime @updatedAt @map("updated_at")

    course       Course @relation("CoursePrerequisite", fields: [courseId], references: [id])
    prerequisite Course @relation("PrerequisiteCourse", fields: [prerequisiteId], references: [id])

    @@id([courseId, prerequisiteId]) // Llave compuesta
    @@map("prerequisites")
}

model Promotion {
    id          String   @id @default(uuid())
    description String // Descripcion
    startDate   DateTime @map("start_date") // fechaInicio
    endDate     DateTime @map("end_date") // fechaFin
    createdAt   DateTime @default(now()) @map("created_at")
    updatedAt   DateTime @updatedAt @map("updated_at")

    courseBranch CourseBranch[]
    graduation   Graduation[]

    @@map("promotions")
}

model CourseBranch {
    id             String             @id @default(uuid())
    promotionId    String             @map("promotion_id") // ID de la promoción
    branchId       String             @map("branch_id") // ID de la sucursal
    teacherId      String             @map("teacher_id") // ID del profesor
    courseId       String             @map("course_id") // ID del curso
    amount         Float              @default(0) // Monto
    taxRate        Float              @default(0) @map("tax_rate")
    isTaxIncluded  Boolean            @default(true) @map("is_tax_included")
    modality       Modality // Modalidad: presencial, virtual, hibrido
    startDate      DateTime?          @map("start_date") // Fecha de inicio
    endDate        DateTime?          @map("end_date") // Fecha de fin
    commissionRate Float              @default(0) @map("commission_rate") // Porcentaje de comisión
    capacity       Int                @default(0) // Capacidad
    sessionCount   Int                @default(0) @map("session_count") // Cantidad de sesiones
    status         CourseBranchStatus // Estado
    createdAt      DateTime           @default(now()) @map("created_at")
    updatedAt      DateTime           @updatedAt @map("updated_at")

    promotion         Promotion           @relation(fields: [promotionId], references: [id])
    branch            Branch              @relation(fields: [branchId], references: [id])
    teacher           Teacher             @relation(fields: [teacherId], references: [id])
    course            Course              @relation(fields: [courseId], references: [id])
    schedules         CourseSchedule[] // Relación con horarios
    enrollment        Enrollment[]
    accountReceivable AccountReceivable[]
    accountPayable    AccountPayable[]
    QuotationItem     QuotationItem[]

    @@map("courses_branches")
}

enum Modality {
    PRESENTIAL @map("presential")
    VIRTUAL    @map("virtual")
    HYBRID     @map("hybrid")
}

enum CourseBranchStatus {
    DRAFT       @map("draft") // Borrador (aun no se ha terminado de configurar)
    WAITING     @map("waiting") // A la espera de alcanzar el limite de estudiantes
    CONFIRMED   @map("confirmed") // Confirmado (alcanzó el limite de estudiantes) y listo para iniciar
    IN_PROGRESS @map("in_progress") // En progreso (ya inició)
    COMPLETED   @map("completed") // Completado (ya finalizó)
    CANCELED    @map("canceled") // Cancelado (no se inició o se canceló antes de finalizar)
}

model Schedule {
    id        String @id @default(uuid())
    startTime String @map("start_time") // Hora de inicio
    endTime   String @map("end_time") // Hora de fin
    weekday   Int // Día de la semana (0 = Domingo, 6 = Sábado)

    deleted   Boolean  @default(false)
    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    courses    CourseSchedule[] // Relación con cursos
    attendance Attendance[]

    @@map("schedules")
}

model CourseSchedule {
    courseId   String   @map("course_id")
    scheduleId String   @map("schedule_id")
    createdAt  DateTime @default(now()) @map("created_at")
    updatedAt  DateTime @updatedAt @map("updated_at")

    course   CourseBranch @relation(fields: [courseId], references: [id])
    schedule Schedule     @relation(fields: [scheduleId], references: [id])

    @@id([courseId, scheduleId]) // Combinación de claves primarias
    @@map("courses_schedules")
}

enum EnrollmentStatus {
    WAITING   @map("waiting")
    ENROLLED  @map("enrolled")
    COMPLETED @map("completed")
    ABANDONED @map("abandoned")
}

model Enrollment {
    id             String           @id @default(uuid())
    studentId      String           @map("student_id") // ID del estudiante
    courseBranchId String           @map("course_branch_id") // ID del CursoSucursal
    enrollmentDate DateTime         @map("enrollment_date") // Fecha de matriculación
    status         EnrollmentStatus // Estado de la matriculación
    createdAt      DateTime         @default(now()) @map("created_at")
    updatedAt      DateTime         @updatedAt @map("updated_at")

    student      Student      @relation(fields: [studentId], references: [id])
    courseBranch CourseBranch @relation(fields: [courseBranchId], references: [id])
    attendance   Attendance[]

    @@map("enrollments")
}

enum AttendanceStatus {
    PRESENT @map("present")
    ABSENT  @map("absent")
    EXCUSED @map("excused")
}

model Attendance {
    id           String           @id @default(uuid())
    enrollmentId String           @map("enrollment_id") // Enrollment ID
    scheduleId   String           @map("schedule_id") // Schedule ID
    date         DateTime // Date of attendance
    status       AttendanceStatus // Status of attendance
    createdAt    DateTime         @default(now()) @map("created_at")
    updatedAt    DateTime         @updatedAt @map("updated_at")

    enrollment Enrollment @relation(fields: [enrollmentId], references: [id])
    schedule   Schedule   @relation(fields: [scheduleId], references: [id])

    @@map("attendances")
}

enum GraduationType {
    DIPLOMA       @map("diploma")
    CERTIFICATE   @map("certificate")
    JURAMENTATION @map("juramentation")
}

enum GraduationStatus {
    PENDING   @map("pending")
    COMPLETED @map("completed")
    CANCELED  @map("canceled")
}

model Graduation {
    id             String           @id @default(uuid())
    studentId      String           @map("student_id") // ID del estudiante
    promotionId    String           @map("promotion_id") // ID de la promoción
    courseId       String           @map("course_id") // ID del curso
    graduationType GraduationType   @map("graduation_type") // Tipo de graduación
    status         GraduationStatus // Estado de la graduación
    date           DateTime // Fecha de graduación
    createdAt      DateTime         @default(now()) @map("created_at")
    updatedAt      DateTime         @updatedAt @map("updated_at")

    student   Student   @relation(fields: [studentId], references: [id])
    promotion Promotion @relation(fields: [promotionId], references: [id])
    course    Course    @relation(fields: [courseId], references: [id])

    @@map("graduations")
}

model GraduationPrice {
    id                             String         @id @default(uuid())
    graduationType                 GraduationType @map("graduation_type") // Tipo de graduación
    basePrice                      Float          @map("base_price") // Precio base
    discountForPreviousCourses     Float          @map("discount_for_previous_courses") // Descuento por cursos previos
    discountForMultipleEnrollments Float          @map("discount_for_multiple_enrollments") // Descuento por múltiples matriculaciones
    createdAt                      DateTime       @default(now()) @map("created_at")
    updatedAt                      DateTime       @updatedAt @map("updated_at")

    @@map("graduation_prices")
}

enum PaymentStatus {
    PENDING  @map("pending")
    PAID     @map("paid")
    CANCELED @map("canceled")
}

model AccountReceivable {
    id             String        @id @default(uuid())
    studentId      String        @map("student_id") // ID del estudiante
    courseBranchId String        @map("course_branch_id") // ID del CursoSucursal
    amount         Float // Monto de la cuota
    dueDate        DateTime      @map("due_date") // Fecha de vencimiento
    status         PaymentStatus @default(PENDING) // Estado (pendiente, pagado, etc.)
    createdAt      DateTime      @default(now()) @map("created_at")
    updatedAt      DateTime      @updatedAt @map("updated_at")

    student           Student             @relation(fields: [studentId], references: [id])
    courseBranch      CourseBranch        @relation(fields: [courseBranchId], references: [id])
    ReceivablePayment ReceivablePayment[]
    InvoiceItem       InvoiceItem[]

    @@map("accounts_receivable")
}

model ReceivablePayment {
    id                  String   @id @default(uuid())
    accountReceivableId String   @map("account_receivable_id")
    amount              Float
    paymentDate         DateTime @map("payment_date")
    cashMovementId      String   @unique @map("cash_movement_id")
    createdAt           DateTime @default(now()) @map("created_at")
    updatedAt           DateTime @updatedAt @map("updated_at")

    accountReceivable AccountReceivable @relation(fields: [accountReceivableId], references: [id])
    cashMovement      CashMovement      @relation(fields: [cashMovementId], references: [id])

    @@map("receivable_payments")
}

model AccountPayable {
    id             String        @id @default(uuid())
    teacherId      String        @map("teacher_id") // ID del teacher
    courseBranchId String        @map("course_branch_id") // ID del CursoSucursal
    amount         Float // Monto a pagar al teacher
    dueDate        DateTime      @map("due_date") // Fecha de vencimiento
    status         PaymentStatus @default(PENDING) // Estado (pendiente, pagado, etc.)
    createdAt      DateTime      @default(now()) @map("created_at")
    updatedAt      DateTime      @updatedAt @map("updated_at")

    teacher        Teacher          @relation(fields: [teacherId], references: [id])
    courseBranch   CourseBranch     @relation(fields: [courseBranchId], references: [id])
    PayablePayment PayablePayment[]

    @@map("accounts_payable")
}

model PayablePayment {
    id               String   @id @default(uuid())
    accountPayableId String   @map("account_payable_id")
    amount           Float
    paymentDate      DateTime @map("payment_date")
    cashMovementId   String   @unique @map("cash_movement_id")
    createdAt        DateTime @default(now()) @map("created_at")
    updatedAt        DateTime @updatedAt @map("updated_at")

    accountPayable AccountPayable @relation(fields: [accountPayableId], references: [id])
    cashMovement   CashMovement   @relation(fields: [cashMovementId], references: [id])

    @@map("payable_payments")
}

model Setting {
    id              String   @id @default(uuid())
    rnc             String   @unique
    companyName     String   @map("company_name")
    address         String
    phone           String
    email           String
    logo            String
    defaultPassword String?  @map("default_password")
    deleted         Boolean  @default(false)
    createdAt       DateTime @default(now()) @map("created_at")
    updatedAt       DateTime @updatedAt @map("updated_at")

    @@map("settings")
}

model Holiday {
    id          String   @id @default(cuid())
    name        String // Nombre del feriado (Ejemplo: "Navidad")
    date        DateTime // Fecha completa (Ejemplo: "2025-12-25")
    isRecurring Boolean  @default(false) @map("is_recurring") // Si el feriado es recurrente
    createdAt   DateTime @default(now()) @map("created_at")
    updatedAt   DateTime @updatedAt @map("updated_at")

    @@map("holidays")
}

enum CashRegisterStatus {
    OPEN   @map("open")
    CLOSED @map("closed")
}

model CashRegister {
    id        String             @id @default(uuid())
    name      String
    branchId  String             @map("branch_id")
    status    CashRegisterStatus @default(OPEN) // "open", "closed"
    userId    String             @map("user_id")
    createdAt DateTime           @default(now()) @map("created_at")
    updatedAt DateTime           @updatedAt @map("updated_at")

    branch    Branch                @relation(fields: [branchId], references: [id])
    user      User                  @relation(fields: [userId], references: [id])
    movements CashMovement[]
    closures  CashRegisterClosure[]
    invoices  Invoice[]             @relation("CashRegisterInvoices") // Nueva relación

    @@map("cash_registers")
}

enum CashMovementType {
    INCOME  @map("income")
    EXPENSE @map("expense")
}

enum CashMovementReferenceType {
    INVOICE            @map("invoice")
    RECEIVABLE_PAYMENT @map("receivable_payment")
    PAYABLE_PAYMENT    @map("payable_payment")
}

model CashMovement {
    id             String                     @id @default(uuid())
    cashRegisterId String                     @map("cash_register_id")
    type           CashMovementType // "income" o "expense"
    amount         Float
    description    String?
    referenceType  CashMovementReferenceType? @default(INVOICE) @map("reference_type") // "Invoice", "ReceivablePayment", "PayablePayment"
    referenceId    String?                    @map("reference_id") // ID de la referencia

    createdBy String   @map("created_by") // Auditoría (Usuario que creó el movimiento)
    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    cashRegister      CashRegister       @relation(fields: [cashRegisterId], references: [id])
    user              User               @relation(fields: [createdBy], references: [id])
    ReceivablePayment ReceivablePayment?
    PayablePayment    PayablePayment?

    @@map("cash_movements")
}

model CashRegisterClosure {
    id             String   @id @default(uuid())
    cashRegisterId String   @map("cash_register_id")
    closureDate    DateTime @map("closure_date")
    initialBalance Float    @default(0) @map("initial_balance")
    totalIncome    Float    @default(0) @map("total_income")
    totalExpense   Float    @default(0) @map("total_expense")
    cashBreakdown  Json?    @map("cash_breakdown") // Desglose de efectivo
    closedBy       String   @map("closed_by") // Usuario que cerró la caja
    createdAt      DateTime @default(now()) @map("created_at")
    updatedAt      DateTime @updatedAt @map("updated_at")

    cashRegister CashRegister @relation(fields: [cashRegisterId], references: [id])
    user         User         @relation(fields: [closedBy], references: [id])

    @@map("cash_register_closures")
}

enum NcfType {
    FACTURA_CREDITO_FISCAL  @map("01") // Factura de Crédito Fiscal
    FACTURA_CONSUMO         @map("02") // Factura de Consumo
    NOTA_DEBITO             @map("03") // Nota de Débito
    NOTA_CREDITO            @map("04") // Nota de Crédito
    COMPROBANTE_COMPRAS     @map("11") // Comprobante de Compras
    REGISTRO_UNICO_INGRESOS @map("12") // Registro Único de Ingresos
    GASTOS_MENORES          @map("13") // Comprobante para Gastos Menores
    REGIMENES_ESPECIALES    @map("14") // Comprobante para Regímenes Especiales
    GUBERNAMENTAL           @map("15") // Comprobante Gubernamental
    EXPORTACION             @map("16") // Comprobante para Exportaciones
    PAGO_EXTERIOR           @map("17") // Comprobante para Pagos al Exterior
}

model NcfRange {
    id              String   @id @default(uuid())
    prefix          String   @default("B")
    type            NcfType
    startSequence   Int      @map("start_sequence") // Inicio del rango, ej. 1
    endSequence     Int      @map("end_sequence") // Fin del rango, ej. 1000
    currentSequence Int      @map("current_sequence") // Secuencia actual, ej. 1
    isActive        Boolean  @default(true) @map("is_active") // Activo o inactivo
    createdAt       DateTime @default(now()) @map("created_at")
    updatedAt       DateTime @updatedAt @map("updated_at")

    @@map("ncf_ranges")
}

enum InvoiceStatus {
    DRAFT    @map("draft") // Factura en proceso, editable (con o sin ítems)
    PAID     @map("paid") // Factura pagada y completada, registrada en caja
    CANCELED @map("canceled") // Factura cancelada antes de pagarse
}

model Invoice {
    id             String        @id @default(uuid())
    invoiceNumber  String        @unique @map("invoice_number")
    ncf            String        @unique
    type           NcfType       @default(FACTURA_CONSUMO) // Tipo de comprobante
    studentId      String?       @map("student_id")
    cashRegisterId String        @map("cash_register_id")
    date           DateTime      @default(now())
    subtotal       Float         @default(0)
    itbis          Float         @default(0)
    paymentDate    DateTime?     @map("payment_date")
    paymentMethod  String?       @default("") @map("payment_method")
    paymentDetails Json?         @default("{}") @map("payment_details") // Detalles adicionales
    status         InvoiceStatus @default(DRAFT) // "draft", "paid", "canceled"

    createdBy String   @map("created_by") // Auditoría
    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    student      Student?      @relation(fields: [studentId], references: [id])
    cashRegister CashRegister  @relation("CashRegisterInvoices", fields: [cashRegisterId], references: [id])
    items        InvoiceItem[]
    user         User          @relation(fields: [createdBy], references: [id])

    @@map("invoices")
}

enum InvoiceItemType {
    PRODUCT    @map("product")
    RECEIVABLE @map("receivable")
    CUSTOM     @map("custom")
}

model InvoiceItem {
    id                  String          @id @default(uuid())
    invoiceId           String          @map("invoice_id")
    type                InvoiceItemType
    productId           String?         @map("product_id")
    accountReceivableId String?         @map("account_receivable_id")
    quantity            Int?            @default(1) @map("quantity")
    unitPrice           Float           @map("unit_price")
    subtotal            Float           @default(0)
    itbis               Float           @default(0)
    createdAt           DateTime        @default(now()) @map("created_at")
    updatedAt           DateTime        @updatedAt @map("updated_at")

    invoice           Invoice            @relation(fields: [invoiceId], references: [id])
    product           Product?           @relation(fields: [productId], references: [id])
    accountReceivable AccountReceivable? @relation(fields: [accountReceivableId], references: [id])

    @@map("invoice_items")
}

model Product {
    id            String   @id @default(uuid())
    code          String   @unique
    name          String
    description   String?
    price         Float
    stock         Int      @default(0)
    taxRate       Float    @default(0) @map("tax_rate")
    isTaxIncluded Boolean  @default(true) @map("is_tax_included")
    deleted       Boolean  @default(false)
    createdAt     DateTime @default(now()) @map("created_at")
    updatedAt     DateTime @updatedAt @map("updated_at")

    invoiceItems  InvoiceItem[]
    QuotationItem QuotationItem[]

    @@map("products")
}

enum QuotationStatus {
    PENDING  @map("pending")
    ACCEPTED @map("accepted")
    REJECTED @map("rejected")
    CANCELED @map("canceled")
}

model Quotation {
    id              String          @id @default(uuid())
    quotationNumber String          @unique @map("quotation_number")
    studentId       String?         @map("student_id")
    date            DateTime
    status          QuotationStatus @default(PENDING) // "pending", "accepted", "rejected"
    createdBy       String          @map("created_by") // Auditoría
    createdAt       DateTime        @default(now()) @map("created_at")
    updatedAt       DateTime        @updatedAt @map("updated_at")

    student Student?        @relation(fields: [studentId], references: [id])
    user    User            @relation(fields: [createdBy], references: [id])
    items   QuotationItem[]

    @@map("quotations")
}

model QuotationItem {
    id             String          @id @default(uuid())
    quotationId    String          @map("quotation_id")
    type           InvoiceItemType // "product", "course", etc.
    productId      String?         @map("product_id")
    courseBranchId String?         @map("course_branch_id")
    quantity       Int             @default(1)
    unitPrice      Float           @map("unit_price")
    subtotal       Float           @default(0)
    itbis          Float           @default(0)
    createdAt      DateTime        @default(now()) @map("created_at")
    updatedAt      DateTime        @updatedAt @map("updated_at")

    quotation    Quotation     @relation(fields: [quotationId], references: [id])
    product      Product?      @relation(fields: [productId], references: [id])
    courseBranch CourseBranch? @relation(fields: [courseBranchId], references: [id])

    @@map("quotation_items")
}
